#!/usr/bin/python2.7

# Made by @lim3ck@
# Vulnerability Scanner for multiple IP addresses inside a network
# Arguments to pass: The filname that contains the vulnerabilities
# that we search for, the network, the subnet mask, the range of the network
# e.g: ./vulnerabiliyScan.py vulnerabilities.txt  192.168.0.0/24 100-104 21,22,23,443,250,445

import socket
import os
import sys

class bcolors:
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    #OKBLUE = '\033[94m'
    #UNDERLINE = '\033[4m'
    #OKCYAN = '\033[96m'
 

def retBanner(ip,port):
    try:
        socket.setdefaulttimeout(2)
        s = socket.socket()
        s.connect((ip,port))
        banner = s.recv(1024)
        return banner
    except:
        return 

def checkVulns(banner, filename, port):
    f = open(filename,"r")

    for line in f.readlines():
        if line.strip("\n") in str(banner):
            print(bcolors.OKGREEN + "\t[+] Server is vulnerable on port "+str(port)+ ": " + str(banner).strip("\n"))

def main():
    
    if len(sys.argv) == 5:
        filename = sys.argv[1]
        if not os.path.isfile(filename):
            print("[-] File doesn't exist! ")
            exit(0) 
        if not os.access(filename,os.R_OK):
            print("[-] Access denied.. ")
            exit(0)     
    elif len(sys.argv)==2:
        print("[-] No IP and subnetmask specified.. ")
        exit(0)
    elif len(sys.argv)== 3:
        print("[-] No IP range specified.. ")
        exit(0) 
    elif len(sys.argv)== 4:
        print("[-] No port list specified.. ")
        exit(0)
    else:
        print("[-] Usage " + str(sys.argv[0]) + " <vuln filname>"+ " <network IP/subnet mask>" + " <IP range separated by \"-\"> <target ports separated by comma>")
        exit(0)

    ip_mask = str(sys.argv[2]).split("/")
    ipv4 = ip_mask[0].split(".")
    ipRange = str(sys.argv[3]).split('-')
    if int(ip_mask[1]) < 24:
        print("[-] Subnetmasks accepted /24-30")
        exit(0)
    if not int(ipv4[3]) == 256-pow(2,32-int(ip_mask[1])):
        print("[-] Wrong subnet mask according to network.. ")
        exit(0)

    if int(ipRange[0]) < int(ipv4[3]):
        print("[-] IP range exceeds the network. ")
        exit(0)
        
    portlist = str(sys.argv[4]).split(',')
    for i in range(0, len(portlist)):
        portlist[i] = int(portlist[i])

    
    for x in range(int(ipRange[0]),int(ipRange[1]) + 1):
        

        ip = str(ipv4[0]) + "." + str(ipv4[1]) + "." + str(ipv4[2]) + "." + str(x) 
        
        print(bcolors.WARNING + "\nScann for " + ip + ": ")
        ok=0
        for port in portlist:
            banner = retBanner(ip,port)
            if banner:
                checkVulns(banner, filename, port)
                ok = ok +1
        if ok == 0:
            print(bcolors.FAIL + "[-] No vulnerabilities found.. " )    

main()
